Tags: #Active_Directory #Samba

**SMB(Server Message Block)** é um protocolo de rede que permite que computadores em uma rede compartilhem arquivos, impressoras e outros recursos em redes **Windows**, também pode ser implementado em sistemas Linux através do software **Samba**.

- **Porta 139 (TCP)** Historicamente. o SMB era executado sobre o NetBIOS over TCP/IP, e a porta 129 era utilizada para as sessões NetBIOS. Em ambientes modernos, o uso da porta 139 para SMB é menos comum e é associado a versões mais antigas do protocolo.

 - **Porta 445(TCP)** É a porta principal para o SMB nas versões modernas do Windows e é a mais utilizada atualmente para compartilhamento de arquivos e outros serviços SMB.

Devemos fazer uma enumeração pela versão do serviço, compartilhamentos, credenciais default, força bruta e caso necessario uma exploração manual.
## Ferramentas para Enumeração

#### Net use**

```
net use [LETRA_DA_UNIDADE]: \\[IP_OU_NOME_DO_SERVIDOR]\[NOME_DO_COMPARTILHAMENTO] [SENHA] /user:[USUARIO]
net use \\<IP>\<Folder>
net use \\<IP> "<password>" /u:<user> #sessão null
Exemplo
	net use Z: \\192.168.1.100\dados_compartilhados /user:usuario_rede
	copy "C:\local\arquivo.txt" "Z:\destino\arquivo.txt" #copiar arquivo
```

#### [[Enum4linux]]
Ferramenta de enumeração SMB que obtém informações detalhadas de compartilhamentos e usuários
```
enum4linux -e <IP>
enum4linux -a <IP> #Enumerar tudo
enum4linux -U <IP> #Enumerar usuários
enum4linux -o <IP> #Enumerar o OS
enum4linux -a -u "<user>" -p "<password>" <IP>
```

#### Nbtscan

### Smbclient
Smbclient é um cliente de linha de comando para o protocolo SMB/CIFS, que permite interagir com compartilhamentos de rede.
Listando compartilhamentos
```
smbclient --no-pass -L //<IP>             #View shares
smblcient -L \\172.16.2.221               #View shares
smbclient -L \\172.16.2.221 -U <Username> #Fazer listagem como um usuário
smbclient -U '%' -N \\\\<IP>\\<SHARE>     #Conectar com uma sessão null
smbclient -U '<user>' -N \\\\<IP>\\<SHARE>
smbclient --no-pass //<IP>/<Folder>       #Conectar ao compartilhamento
smbclient //<IP>/<Folder> --workgroup <domain> --user <username>
smbclient //server/share --directory path/to/directory --command "get file.txt" #Download
smbclient //server/share --directory path/to/directory --command "put file.txt" #Upload
smbclient --list=server --no-pass         #Listagem anonima
smbclient -U 'username[%password]' -L [--pw-nt-hash] //<IP> #Se você usar esta opção em vez de fornecer a senha em texto claro, você pode fornecer o hash NTLM da senha.
```

**`--pw-nt-hash`**: Se você usar esta opção, em vez de fornecer a senha em texto claro (ou ser solicitado a digitá-la), você pode fornecer o **hash NTLM da senha**. Isso é comumente usado em cenários de segurança ou pentesting, onde você pode ter o hash da senha de um usuário, mas não a senha em texto claro.
**`--option='client min protocol=nt1`** usar a versão 1 do smb.

#### Nmap Scripts:
O nmap possui scripts para enumeração de alguns protocolos, no caso do SMB temos:
```
smb-enum-shares   #Enumera compartilhamentos do SMB.
smb-brute         #Executa um pequeno brute-force por senhas.
smb-system-info   #Coleta informações sobre o SMB/NetBIOS.
smb-vuln-smb/cve* #Identifica se a versão do SMB é vulneravel a algum exploit.
Exemplo:
	nmap -p 139,445 --script [script name] <IP>
```

#### Smbmap
```
smbmap -u "username" -p "password" -H <IP> [-P <PORT>]
smbmap -u "username" -p "<NT>:LM" -H <IP> [-P <PORT>] #Senha como hash
smbmap -u "username" -p "password" -R [Folder] -H <IP> [-P <PORT>] #Recursive list
smbmap -u "username" -p "password" -r [Folder] -H <IP> [-P <PORT>] #Recursive list
```
